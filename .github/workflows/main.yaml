name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DEPLOY_DIR: ${{ secrets.DEPLOY_DIR || '~/deploy-project' }}
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    if: github.repository == 'wignn/deploy-project'

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          timeout: 60s
          command_timeout: 30m
          script: |
            set -e
            
            DEPLOY_DIR="${{ env.DEPLOY_DIR }}"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            
            echo "==> Preparing deployment directory"
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Cloning repository..."
              git clone --recurse-submodules "$REPO_URL" "$DEPLOY_DIR"
            fi
            
            cd "$DEPLOY_DIR"
            
            echo "==> Fetching latest changes"
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            echo "==> Cleaning submodule directories"
            # Remove existing submodule directories if they're not proper git repos
            if [ -d "porto" ] && [ ! -d "porto/.git" ]; then
              echo "Removing corrupted porto directory..."
              rm -rf porto
            fi
            
            if [ -d "server-monitoring" ] && [ ! -d "server-monitoring/.git" ]; then
              echo "Removing corrupted server-monitoring directory..."
              rm -rf server-monitoring
            fi
            
            echo "==> Initializing and updating submodules"
            git submodule sync --recursive
            git submodule update --init --recursive --force
            
            echo "==> Verifying submodules"
            git submodule status
            ls -la porto/ server-monitoring/
            
            echo "==> Creating environment files"
            cat > .env << 'EOL'
            ${{ secrets.ENV_GLOBAL }}
            EOL
            
            echo "==> Creating SSL certificates"
            mkdir -p cert
            chmod 700 cert
            
            cat > cert/Origin-Certificate.pem << 'EOL'
            ${{ secrets.SSL_ORIGIN_CERT }}
            EOL
            
            cat > cert/Private-Key.pem << 'EOL'
            ${{ secrets.SSL_PRIVATE_KEY }}
            EOL
            
            chmod 600 cert/Origin-Certificate.pem
            chmod 600 cert/Private-Key.pem
            
            echo "==> Verifying files"
            ls -la .env
            ls -la cert/
            
            echo "==> Validating SSL certificates"
            openssl x509 -in cert/Origin-Certificate.pem -noout -text > /dev/null && echo "✓ Certificate valid" || echo "✗ Certificate invalid"
            openssl rsa -in cert/Private-Key.pem -check -noout > /dev/null 2>&1 && echo "✓ Private key valid" || echo "✗ Private key invalid"
            
            echo "==> Stopping containers"
            docker compose down --remove-orphans || true
            
            echo "==> Pruning old resources"
            docker system prune -af --volumes || true
            
            echo "==> Building images"
            docker compose build --no-cache --pull
            
            echo "==> Starting services"
            docker compose up -d --force-recreate
            
            echo "==> Waiting for services to be healthy"
            timeout 120 sh -c 'until docker compose ps | grep -q "healthy"; do sleep 2; done' || true
            
            echo "==> Deployment Status"
            docker compose ps
            docker compose logs --tail=50
            
            echo "==> Cleaning up"
            docker image prune -af || true
            
            echo "==> Deployment completed successfully!"

      - name: Health Check
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd "${{ env.DEPLOY_DIR }}"
            
            echo "==> Service Health Status"
            docker compose ps
            
            echo "==> Testing Endpoints"
            curl -f http://localhost:3000 || echo "Porto: Not responding"
            curl -f http://localhost:8081/health || echo "Monitoring: Not responding"
            
            echo "==> SSL Certificate Info"
            openssl x509 -in cert/Origin-Certificate.pem -noout -dates -subject || true
            
            echo "==> Recent Logs"
            docker compose logs --tail=20

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd "${{ env.DEPLOY_DIR }}"
            
            echo "==> Deployment failed, rolling back"
            git reset --hard HEAD~1
            git submodule update --init --recursive --force
            
            docker compose down
            docker compose up -d
            
            echo "==> Rollback completed"
            docker compose ps

      - name: Cleanup Sensitive Files
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd "${{ env.DEPLOY_DIR }}"
            
            echo "==> Securing sensitive files"
            chmod 600 .env 2>/dev/null || true
            chmod 600 cert/*.pem 2>/dev/null || true
            
            echo "==> File permissions set"
            ls -la .env cert/

      - name: Notification
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd "${{ env.DEPLOY_DIR }}"
            
            STATUS="${{ job.status }}"
            COMMIT="${{ github.sha }}"
            ACTOR="${{ github.actor }}"
            
            echo "==> Deployment $STATUS"
            echo "Commit: $COMMIT"
            echo "Triggered by: $ACTOR"
            echo "Timestamp: $(date)"