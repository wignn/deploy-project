name: Production Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DEPLOY_DIR: ${{ secrets.DEPLOY_DIR || '~/deploy-project' }}
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    if: github.repository == 'wignn/deploy-project'
    timeout-minutes: 45

    steps:
      - name: Deploy Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          timeout: 60s
          command_timeout: 30m
          script: |
            set -e
            
            DEPLOY_DIR="${{ env.DEPLOY_DIR }}"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            
            echo "Preparing deployment directory..."
            
            if [ -d "$DEPLOY_DIR" ]; then
              cd "$DEPLOY_DIR"
              if ! git rev-parse --git-dir > /dev/null 2>&1; then
                echo "Invalid repository detected, reinitializing..."
                cd ..
                rm -rf "$DEPLOY_DIR"
                git clone --recurse-submodules "$REPO_URL" "$DEPLOY_DIR"
                cd "$DEPLOY_DIR"
              else
                echo "Valid repository found"
              fi
            else
              echo "Cloning repository..."
              git clone --recurse-submodules "$REPO_URL" "$DEPLOY_DIR"
              cd "$DEPLOY_DIR"
            fi
            
            echo "Fetching latest changes..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # Clean corrupted submodule directories
            for submodule in porto server-monitoring; do
              if [ -d "$submodule" ] && [ ! -d "$submodule/.git" ]; then
                echo "Removing corrupted $submodule directory..."
                rm -rf "$submodule"
              fi
            done
            
            echo "Updating submodules..."
            git config --global url."https://${{ secrets.GH_TOKEN }}@github.com/".insteadOf "https://github.com/"
            git submodule sync --recursive
            git submodule update --init --recursive --force
            git config --global --unset url."https://${{ secrets.GH_TOKEN }}@github.com/".insteadOf
            
            echo "Submodules updated successfully"
            git submodule status
            
            echo "Creating environment files..."
            cat > .env << 'EOL'
            ${{ secrets.ENV_GLOBAL }}
            EOL
            
            echo "Installing SSL certificates..."
            mkdir -p cert
            chmod 700 cert
            
            cat > cert/Origin-Certificate.pem << 'EOL'
            ${{ secrets.SSL_ORIGIN_CERT }}
            EOL
            
            cat > cert/Private-Key.pem << 'EOL'
            ${{ secrets.SSL_PRIVATE_KEY }}
            EOL
            
            chmod 600 cert/Origin-Certificate.pem cert/Private-Key.pem
            
            # Validate certificates
            if openssl x509 -in cert/Origin-Certificate.pem -noout -text > /dev/null 2>&1; then
              echo "SSL certificate valid"
            else
              echo "SSL certificate invalid"
              exit 1
            fi
            
            if openssl rsa -in cert/Private-Key.pem -check -noout > /dev/null 2>&1; then
              echo "Private key valid"
            else
              echo "Private key invalid"
              exit 1
            fi
            
            echo "Stopping existing containers..."
            docker compose down --remove-orphans || true
            
            echo "Pruning old Docker resources..."
            docker system prune -af --volumes || true
            
            echo "Building Docker images..."
            docker compose build --no-cache --pull
            
            echo "Starting services..."
            docker compose up -d --force-recreate
            
            echo "Waiting for services to be healthy..."
            timeout 120 sh -c 'until docker compose ps | grep -q "healthy"; do sleep 2; done' || echo "Health check timeout"
            
            echo ""
            echo "DEPLOYMENT COMPLETED SUCCESSFULLY"
            docker compose ps
            echo ""
            echo "Recent logs:"
            docker compose logs --tail=30
            
            # Cleanup
            docker image prune -af || true

      - name: Health Check
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd "${{ env.DEPLOY_DIR }}"
            
            echo "Service Health Status"
            docker compose ps
            
            echo ""
            echo "Testing Endpoints"
            if curl -f -s http://localhost:3000 > /dev/null; then
              echo "Porto: Healthy"
            else
              echo "Porto: Not responding"
            fi
            
            if curl -f -s http://localhost:8081/health > /dev/null; then
              echo "Monitoring: Healthy"
            else
              echo "Monitoring: Not responding"
            fi
            
            echo ""
            echo "SSL Certificate Information"
            openssl x509 -in cert/Origin-Certificate.pem -noout -dates -subject 2>/dev/null || echo "Unable to read certificate"

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd "${{ env.DEPLOY_DIR }}"
            
            echo "DEPLOYMENT FAILED - INITIATING ROLLBACK"
            
            git reset --hard HEAD~1
            git submodule update --init --recursive --force
            
            docker compose down
            docker compose up -d
            
            echo ""
            echo "Rollback completed"
            docker compose ps

      - name: Secure Sensitive Files
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd "${{ env.DEPLOY_DIR }}"
            
            echo "Securing sensitive files..."
            chmod 600 .env 2>/dev/null || true
            chmod 600 cert/*.pem 2>/dev/null || true
            
            echo "File permissions secured"

      - name: Deployment Summary
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo ""
            echo "Status      : ${{ job.status }}"
            echo "Commit      : ${{ github.sha }}"
            echo "Branch      : ${{ github.ref_name }}"
            echo "Triggered by: ${{ github.actor }}"
            echo "Timestamp   : $(date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "Repository  : ${{ github.repository }}"